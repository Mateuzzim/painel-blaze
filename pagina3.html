<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P√°gina 3 - C√≥digo Fonte</title>
    <style>
        body { background-color: #0f0f13; color: #ccc; font-family: monospace; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        h2 { text-align: center; color: #ff9800; margin: 10px 0; }
        textarea { flex: 1; background: #111; color: #0f0; border: none; padding: 20px; font-family: monospace; font-size: 14px; resize: none; outline: none; }
        .navegacao { text-align: center; padding: 20px; background: #0f0f13; border-top: 1px solid #333; font-size: 1.2rem; }
        .navegacao a { color: #00d2ff; text-decoration: none; font-weight: bold; margin: 0 15px; }
        .navegacao a:hover { color: #fff; text-shadow: 0 0 10px #00d2ff; }
        .navegacao span { color: #555; margin: 0 15px; cursor: default; }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <!-- BcryptJS para Hash Seguro de Senhas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script>
</head>
<body>
    <h2>P√°gina 3: L√≥gica de Login e Rob√¥s</h2>
    <script src="firebase-config.js"></script>
    <script>
        async function handleLogin(event) {
            event.preventDefault();
            const errorDiv = document.getElementById('login-error');
            const username = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            const loginButton = document.getElementById('login-button');
            const buttonText = loginButton.querySelector('.login-button-text');
            const spinner = loginButton.querySelector('.login-spinner');
        
            // Valida√ß√£o b√°sica de entrada
            if (!username || !pass) {
                errorDiv.textContent = 'Preencha usu√°rio e senha.';
                return;
            }

            if (MAINTENANCE_MODE) {
                errorDiv.textContent = 'Sistema em manuten√ß√£o. Tente novamente mais tarde.';
                return;
            }
        
            // Inicia o estado de carregamento
            loginButton.disabled = true;
            buttonText.style.display = 'none';
            spinner.style.display = 'block';
            errorDiv.textContent = '';
        
            // 1. Verifica credenciais fixas de admin (mantido como caso especial)
            if (username === 'operador' && pass === 'senha123') {
                logActivity(username, 'Login (Admin)', true);
                sessionStorage.setItem('isLoggedIn', 'true');
                sessionStorage.setItem('operatorName', username);
                sessionStorage.setItem('accessLevel', 'admin');
                showApp();
                return;
            }
        
            // 2. Se n√£o for admin, consulta o Firebase
            try {
                const querySnapshot = await db.collection("users").where("username", "==", username).get();
        
                if (querySnapshot.empty) {
                    throw new Error('Usu√°rio ou senha inv√°lidos.');
                }
        
                const userDoc = querySnapshot.docs[0];
                const foundUser = userDoc.data();
                const userId = userDoc.id;
        
                // NOVO: Verifica se a conta est√° bloqueada manualmente
                if (foundUser.isBlocked === true) {
                    logActivity(username, 'Login Falhou (Bloqueado)', false);
                    throw new Error('Esta conta foi bloqueada manualmente. Contate o suporte.');
                }

                // Verifica a senha (suporta Bcrypt e Base64 legado)
                let isPasswordCorrect = false;
                
                if (foundUser.password && foundUser.password.startsWith('$2a$')) {
                    isPasswordCorrect = await verifyPassword(pass, foundUser.password);
                } else {
                    try {
                        if (atob(foundUser.password) === pass) isPasswordCorrect = true;
                    } catch (e) {
                        // Fallback se atob falhar (ex: senha n√£o √© base64 v√°lida)
                        if (foundUser.password === pass) isPasswordCorrect = true;
                    }
                }

                if (!isPasswordCorrect) throw new Error('Usu√°rio ou senha inv√°lidos.');
        
                // Verifica se a conta expirou
                if (foundUser.expiresAt && new Date(foundUser.expiresAt) < new Date()) {
                    const contactMessage = `Seu per√≠odo de acesso expirou. <a href="tg://resolve?domain=${TELEGRAM_SUPPORT_USERNAME}&text=Ol√°, meu acesso para o usu√°rio '${username}' expirou. Gostaria de renovar." target="_blank" style="color: var(--accent-jonbet); text-decoration: underline;">Clique aqui para renovar via Telegram</a>.`;
                    errorDiv.innerHTML = contactMessage;
                    logActivity(username, 'Login Falhou (Expirado)', false);
                } else {
                    // Login bem-sucedido
                    logActivity(username, 'Login', true);
                    sessionStorage.setItem('isLoggedIn', 'true');
                    sessionStorage.setItem('operatorName', username);
                    sessionStorage.setItem('accessLevel', foundUser.accessLevel);

                    // Envia notifica√ß√£o para o admin sobre o login do usu√°rio
                    const now = new Date();
                    const loginTime = now.toLocaleString('pt-BR');
                    const notificationMessage = `üë§ *Login Detectado*\n\n*Usu√°rio:* \`${username}\`\n*N√≠vel:* ${foundUser.accessLevel}\n*Data/Hora:* ${loginTime}`;
                    sendTelegramNotification(notificationMessage);

        
                    // SUGEST√ÉO: Captura o ID do Telegram no primeiro login
                    if (foundUser.accessLevel !== 'admin' && !foundUser.telegramId) {
                        const tg = window.Telegram.WebApp;
                        if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                            const telegramId = tg.initDataUnsafe.user.id;
                            // Atualiza o documento do usu√°rio no Firebase com o novo ID
                            db.collection("users").doc(userId).update({ telegramId: telegramId })
                            .then(() => {
                                console.log(`ID do Telegram (${telegramId}) vinculado ao usu√°rio ${username}.`);
                                sendAdminNotification('‚úÖ ID de Usu√°rio Vinculado', `O ID do Telegram para '${username}' foi capturado: ${telegramId}`);
                            })
                            .catch(err => {
                                console.error("Erro ao vincular ID do Telegram:", err);
                            });
                        }
                    }
        
                    showApp();
                }
        
            } catch (error) {
                errorDiv.textContent = error.message;
                logActivity(username, 'Login Falhou', false);
            } finally {
                // Restaura o bot√£o ao estado original, independentemente do resultado
                loginButton.disabled = false;
                buttonText.style.display = 'inline';
                spinner.style.display = 'none';
            }
        }

        async function handleSelfRegister(event) {
            event.preventDefault();
            const errorDiv = document.getElementById('self-register-error');
            errorDiv.textContent = '‚è≥ Criando sua conta...';
            errorDiv.style.color = 'var(--text-color)';

            const username = document.getElementById('self_reg_username').value.trim();
            const contact = document.getElementById('self_reg_contact').value.trim();
            const password = document.getElementById('self_reg_password').value;
            const confirmPassword = document.getElementById('self_reg_confirm_password').value;

            // --- Valida√ß√µes ---
            if (!username || !password) {
                errorDiv.textContent = '‚ùå Nome de usu√°rio e senha s√£o obrigat√≥rios.';
                errorDiv.style.color = 'var(--accent-blaze)';
                return;
            }
            if (password !== confirmPassword) {
                errorDiv.textContent = '‚ùå As senhas n√£o coincidem.';
                errorDiv.style.color = 'var(--accent-blaze)';
                return;
            }
            if (/[A-Z]/.test(username)) {
                errorDiv.textContent = '‚ùå O nome de usu√°rio n√£o pode conter letras mai√∫sculas.';
                errorDiv.style.color = 'var(--accent-blaze)';
                return;
            }
            if (/\s/.test(username)) {
                errorDiv.textContent = '‚ùå O nome de usu√°rio n√£o pode conter espa√ßos (n√£o √© permitido nome completo).';
                errorDiv.style.color = 'var(--accent-blaze)';
                return;
            }



            // --- Prepara dados do novo usu√°rio ---
            const expDate = new Date();
            expDate.setDate(expDate.getDate() + 3); // Adiciona 3 dias de acesso

            const newUser = {
                username: username,
                password: await hashPassword(password), // Hash seguro
                contact: contact || null,
                telegramId: null,
                accessLevel: 'operator', // N√≠vel de acesso definido como operador
                expiresAt: expDate.toISOString(),
                createdAt: new Date().toISOString()
            };

            // --- Salva no Firebase ---
            try {
                // VERIFICA√á√ÉO DE ID DE TELEGRAM DUPLICADO
                const tg = window.Telegram.WebApp;
                let capturedTelegramId = null;
                if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    capturedTelegramId = tg.initDataUnsafe.user.id;

                    // Procura por usu√°rios existentes com o mesmo ID do Telegram
                    const telegramIdQuery = await db.collection("users").where("telegramId", "==", capturedTelegramId).get();

                    if (!telegramIdQuery.empty) {
                        // Se encontrar, bloqueia o cadastro
                        throw new Error("Voc√™ j√° possui uma conta cadastrada com este usu√°rio do Telegram.");
                    }

                    // VERIFICA√á√ÉO DE HIST√ìRICO DE TESTE (Evita criar m√∫ltiplas contas ap√≥s exclus√£o)
                    const trialHistoryDoc = await db.collection("trial_history").doc(String(capturedTelegramId)).get();
                    if (trialHistoryDoc.exists) {
                        throw new Error("Voc√™ j√° utilizou seu per√≠odo de teste gratuito de 3 dias.");
                    }
                }

                const querySnapshot = await db.collection("users").where("username", "==", username).get();
                if (!querySnapshot.empty) {
                    throw new Error("Este nome de usu√°rio j√° est√° em uso.");
                }

                // Adiciona o ID do Telegram capturado ao novo usu√°rio
                newUser.telegramId = capturedTelegramId;

                await db.collection("users").add(newUser);

                // Registra o uso do teste gratuito no hist√≥rico permanente
                if (capturedTelegramId) {
                    await db.collection("trial_history").doc(String(capturedTelegramId)).set({
                        username: username,
                        usedAt: new Date().toISOString()
                    });
                }

                // Notifica o administrador sobre o novo cadastro
                const adminMessage = `üéâ *Novo Cadastro Realizado*\n\n*Usu√°rio:* \`${username}\`\n*Contato:* ${contact || 'N√£o informado'}\n*Acesso at√©:* ${expDate.toLocaleDateString('pt-BR')}`;
                sendTelegramNotification(adminMessage);

                // Notifica o usu√°rio sobre a ativa√ß√£o do teste de 3 dias
                if (capturedTelegramId) {
                    const userTrialMessage = `üöÄ *Teste de 3 Dias Ativado!*\n\nOl√° *${username}*, seja bem-vindo!\n\n‚úÖ Seu acesso de teste foi liberado com sucesso.\nüìÖ *V√°lido at√©:* ${expDate.toLocaleDateString('pt-BR')}\n\nAproveite todas as funcionalidades da plataforma!`;
                    sendTelegramNotification(userTrialMessage, capturedTelegramId);
                }

                errorDiv.innerHTML = `‚úÖ Conta criada com sucesso! Voc√™ j√° pode fazer o login.`;
                errorDiv.style.color = 'var(--accent-jonbet)';
                document.getElementById('self-register-form').reset();

            } catch (error) {
                console.error("Erro no auto-cadastro: ", error);
                errorDiv.textContent = `‚ùå ERRO: ${error.message}`;
                errorDiv.style.color = 'var(--accent-blaze)';
            }
        }

        function showApp() {
            console.log("showApp() called. Displaying main application."); // New log
            // Esconde o login e mostra o container principal do app
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';

            // SUGEST√ÉO: Verifica a expira√ß√£o do acesso ao mostrar o app
            const accessLevel = sessionStorage.getItem('accessLevel');
            if (accessLevel !== 'admin') {
                const users = JSON.parse(sessionStorage.getItem('app_users_temp')) || [];
                const currentUser = users.find(u => u.username.toLowerCase() === sessionStorage.getItem('operatorName').toLowerCase());

                if (currentUser && currentUser.expiresAt) {
                    const expirationDate = new Date(currentUser.expiresAt);
                    const daysLeft = (expirationDate - new Date()) / (1000 * 60 * 60 * 24);

                    if (daysLeft <= 3) { // Notifica se faltam 3 dias ou menos
                        const notificationDiv = document.getElementById('expiration-notification');
                        const renewLink = document.getElementById('renew-link');
                        const message = `Ol√°, meu acesso para o usu√°rio '${currentUser.username}' est√° expirando. Gostaria de renovar.`;
                        renewLink.href = `tg://resolve?domain=${TELEGRAM_SUPPORT_USERNAME}&text=${encodeURIComponent(message)}`;
                        
                        if (daysLeft <= 1) {
                            notificationDiv.style.backgroundColor = 'var(--accent-blaze)';
                            notificationDiv.style.color = '#fff';
                        }
                        notificationDiv.style.display = 'block';
                    }
                }
            }

            const operatorName = sessionStorage.getItem('operatorName');
            setupOperatorInfo(operatorName);
            applyAccessControl(); // Aplica as restri√ß√µes de acesso

            // Tenta migrar senhas antigas silenciosamente em segundo plano
            migratePasswords().catch(err => console.error("Erro na migra√ß√£o autom√°tica:", err));

            // REMOVIDO: O c√≥digo abaixo recarregava a p√°gina a cada 10 minutos, o que causava interrup√ß√µes.
            // setInterval(() => {
            //     console.log("Recarregando a p√°gina automaticamente...");
            //     location.reload();
            // }, 10 * 60 * 1000); // 10 minutos
        }

        function setupOperatorInfo(operatorName) {
            console.log("setupOperatorInfo called for:", operatorName); // Log para depura√ß√£o
             if (!operatorName) return;

             // // Mostra a mensagem de boas-vindas (OCULTADO A PEDIDO)
             // const welcomeMessage = document.getElementById('welcome-message');
             // welcomeMessage.textContent = `Bem-vindo, ${operatorName.toUpperCase()}!`;
             // welcomeMessage.style.display = 'block';
             // setTimeout(() => {
             //     welcomeMessage.style.display = 'none';
             // }, 3000);

             // Atualiza o t√≠tulo principal com o nome do operador
            // SUGEST√ÉO: Ativa a busca autom√°tica por padr√£o ao carregar a p√°gina
            const autoFetchToggleDefault = document.getElementById('dash_autoFetchToggle');
            if (autoFetchToggleDefault && !autoFetchToggleDefault.checked) {
                // GARANTIA: Certifique-se de que a an√°lise autom√°tica tamb√©m esteja ativada
                const autoAnalyzeToggle = document.getElementById('dash_autoAnalyzeToggle');
                if (autoAnalyzeToggle) autoAnalyzeToggle.checked = true;

                console.log("Auto-Busca toggle not checked, attempting to activate."); // Log para depura√ß√£o
                // Marca o checkbox como ativado
                autoFetchToggleDefault.checked = true;
                // Dispara o evento 'change' para iniciar a l√≥gica de busca autom√°tica
                autoFetchToggleDefault.dispatchEvent(new Event('change'));
                console.log("Auto-Busca iniciada automaticamente por padr√£o ap√≥s o login.");
            }
            console.log("Current state of autoFetchToggleDefault.checked:", autoFetchToggleDefault ? autoFetchToggleDefault.checked : 'N/A'); // Log para depura√ß√£o

            // Ativa a An√°lise Autom√°tica por padr√£o ao carregar a p√°gina
            const autoAnalyzeToggleDefault = document.getElementById('dash_autoAnalyzeToggle');
            if (autoAnalyzeToggleDefault && !autoAnalyzeToggleDefault.checked) {
                autoAnalyzeToggleDefault.checked = true;
                // N√£o √© necess√°rio disparar o evento 'change' aqui, pois a l√≥gica de an√°lise √© acionada pela Auto-Busca.
                console.log("An√°lise Autom√°tica ativada automaticamente por padr√£o ap√≥s o login.");
            }

             // document.getElementById('main-title').textContent = `CORTEX VIRTUAL - ${operatorName.toUpperCase()}`;
        }

        function applyAccessControl() {
            const accessLevel = sessionStorage.getItem('accessLevel');
            const userTab = document.getElementById('suite_tab_usuarios');

            // L√≥gica para Convidado
            // A l√≥gica para 'operator' tamb√©m cair√° aqui, escondendo a aba de admin corretamente.
            if (accessLevel === 'guest') {
                const permissions = getGuestPermissions();
                let firstVisibleTab = null;

                document.querySelectorAll('.suite .tabs .tab-btn').forEach(btn => {
                    const onclickAttr = btn.getAttribute('onclick');
                    if (onclickAttr) {
                        const tabName = onclickAttr.match(/'(.*?)'/)[1];
                        if (permissions[tabName]) {
                            if (!firstVisibleTab) firstVisibleTab = tabName; // Guarda a primeira aba vis√≠vel
                        } else {
                            // Esconde o bot√£o se n√£o tiver permiss√£o e n√£o for uma aba de admin
                            if (tabName !== 'config' && tabName !== 'usuarios') {
                                btn.style.display = 'none';
                            }
                        }
                    }
                });

                if (!permissions.dashboard) {
                    const dashboardPanel = document.querySelector('.layout-panel.dashboard');
                    if (dashboardPanel) dashboardPanel.style.display = 'none';
                }

                suite_openTab(firstVisibleTab || 'gerador'); // Abre a primeira aba permitida
            }
            // L√≥gica para Admin (movida para o final para garantir a execu√ß√£o correta)
            else if (accessLevel === 'admin') {
                if (userTab) userTab.style.display = 'block';
                const telegramPanel = document.getElementById('telegram-panel');
                if (telegramPanel) telegramPanel.style.display = 'block';
                const sendListBtn = document.getElementById('send-generated-list-to-telegram-btn');
                if (sendListBtn) sendListBtn.style.display = 'block';
                const sendAnalysisBtn = document.getElementById('send-analysis-to-telegram-btn');
                if (sendAnalysisBtn) sendAnalysisBtn.style.display = 'block';
                const apiConfig = document.getElementById('admin-api-config');
                if (apiConfig) apiConfig.style.display = 'block';
                // Popula as listas que o admin precisa ver
                populateUserList();
                populateActivityLog();
                setupPermissionControls();
            }

        }

        function initializeApp() {

            // --- L√ìGICA PARA ALTERNAR ENTRE LOGIN E CADASTRO ---
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('self-register-form');
            const showRegisterLink = document.getElementById('show-register-link');
            const showLoginLink = document.getElementById('show-login-link');
 

            showRegisterLink.addEventListener('click', (e) => {
                e.preventDefault();
                loginForm.classList.remove('form-active');
                loginForm.classList.add('form-inactive');
                registerForm.classList.remove('form-inactive');
                registerForm.classList.add('form-active');
            });

            showLoginLink.addEventListener('click', (e) => {
                e.preventDefault();
                registerForm.classList.remove('form-active');
                registerForm.classList.add('form-inactive');
                loginForm.classList.remove('form-inactive');
                loginForm.classList.add('form-active');
            });

            // SUGEST√ÉO: Centraliza a configura√ß√£o do listener do Auto-Busca aqui para garantir que ele exista antes de ser ativado.
            const autoFetchToggle = document.getElementById('dash_autoFetchToggle');
            const fetchDataBtn = document.getElementById('dash_fetchDataBtn');
            if (autoFetchToggle && fetchDataBtn) {
                autoFetchToggle.addEventListener('change', (event) => {
                    fetchDataBtn.disabled = event.target.checked;
                    // NOVO: Atualiza o status do rob√¥ quando a auto-busca √© alterada
                    const botStatusDiv = document.getElementById('autoBotStatus');
                    if (botStatusDiv && document.getElementById('autoBotToggle').checked) {
                        if (event.target.checked) {
                            botStatusDiv.innerHTML = '<span class="cortex-text-anim">‚úÖ Rob√¥ Ativado. Monitorando novos resultados...</span>';
                        } else {
                            botStatusDiv.textContent = 'Aguardando ativa√ß√£o da "Auto-Busca" no painel direito.';
                        }
                    }

                    const whiteStatusDiv = document.getElementById('whiteBotStatus');
                    if (whiteStatusDiv && document.getElementById('whiteBotToggle').checked) {
                        if (event.target.checked) {
                            whiteStatusDiv.innerHTML = '<span class="cortex-text-anim">‚úÖ Rob√¥ Branco Ativado. Monitorando...</span>';
                        } else {
                            whiteStatusDiv.textContent = 'Aguardando ativa√ß√£o da "Auto-Busca" no painel direito.';
                        }
                    }

                    if (event.target.checked) {
                        fetchDataBtn.style.cursor = 'not-allowed';
                        console.log("Auto-Busca ativada. Iniciando busca...");
                        dash_autoFetchBlaze().then(() => {
                            if (document.getElementById('dash_autoAnalyzeToggle').checked) {
                                dash_processarDados();
                            }
                        });
                        // Limpa qualquer intervalo anterior para evitar duplicatas
                        if (autoFetchIntervalId) clearInterval(autoFetchIntervalId);
                        
                        autoFetchIntervalId = setInterval(() => {
                            console.log("Executando busca autom√°tica peri√≥dica...");
                            dash_autoFetchBlaze().then(() => {
                                if (document.getElementById('dash_autoAnalyzeToggle').checked) {
                                    dash_processarDados();
                                }
                            });
                        }, 15000); // Verifica a cada 15 segundos para atualiza√ß√£o r√°pida
                    } else {
                        clearInterval(autoFetchIntervalId);
                        autoFetchIntervalId = null;
                        fetchDataBtn.style.cursor = 'pointer';
                        console.log("Auto-Busca desativada.");
                    }
                });
            }

            // Restaura abas e plataformas
            const suiteActiveTab = 'gerador'; // Padr√£o, j√° que n√£o h√° mais localStorage
            suite_openTab(suiteActiveTab);

            dash_openTab('analise');
            dash_selectPlatform('blaze');
            dash_processarDados(true);
            toggleRealTimeDirection();

            // OTIMIZA√á√ÉO: Delega√ß√£o de eventos para o grid de resultados
            // Em vez de adicionar um evento em cada badge, adicionamos um no pai.
            const dashGrid = document.getElementById('dash_grid-resultados');
            if (dashGrid) {
                dashGrid.addEventListener('click', (e) => {
                    const badge = e.target.closest('.badge');
                    if (badge) {
                        dash_toggleDeleteOption(badge);
                    }
                });
            }
        }

        // ==========================================
        // IN√çCIO: L√ìGICA DO ROB√î AUTOM√ÅTICO
        // ==========================================
        // ... (O restante do c√≥digo foi movido para a p√°gina 3)
    </script>
    <div class="navegacao">
        <a href="pagina2.html">Anterior</a> | <span>Pr√≥xima</span>
    </div>
</body>
</html>