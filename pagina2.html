<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P√°gina 2 - C√≥digo Fonte</title>
    <style>
        body { background-color: #0f0f13; color: #ccc; font-family: monospace; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        h2 { text-align: center; color: #ff9800; margin: 10px 0; }
        textarea { flex: 1; background: #111; color: #0f0; border: none; padding: 20px; font-family: monospace; font-size: 14px; resize: none; outline: none; }
        .navegacao { text-align: center; padding: 20px; background: #0f0f13; border-top: 1px solid #333; font-size: 1.2rem; }
        .navegacao a { color: #00d2ff; text-decoration: none; font-weight: bold; margin: 0 15px; }
        .navegacao a:hover { color: #fff; text-shadow: 0 0 10px #00d2ff; }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <!-- BcryptJS para Hash Seguro de Senhas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script>
</head>
<body>
    <h2>P√°gina 2: Inicializa√ß√£o e Fun√ß√µes Auxiliares</h2>
    <script src="firebase-config.js"></script>
    <script>
        // ==========================================
        // FIM: SCRIPTS DE coressao_de_sinais.html
        // ==========================================


        // ==========================================
        // INICIALIZA√á√ÉO DA P√ÅGINA
        // ==========================================
        // SUGEST√ÉO: Fun√ß√£o para atualizar o rel√≥gio digital
        function updateClock() {
            const clockElement = document.getElementById('digital-clock');
            if (clockElement) {
                const now = new Date();
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                const seconds = now.getSeconds().toString().padStart(2, '0');
                clockElement.textContent = `${hours}:${minutes}:${seconds}`;
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
            // Verifica o modo de manuten√ß√£o ao carregar a p√°gina
            const urlParams = new URLSearchParams(window.location.search);
            const isLogout = urlParams.get('logout') === 'true';

            if (MAINTENANCE_MODE) {
                document.getElementById('username').disabled = true;
                document.getElementById('password').disabled = true;
                const loginButtonMaintenance = document.getElementById('login-button');
                loginButtonMaintenance.disabled = true;
                loginButtonMaintenance.querySelector('.login-button-text').textContent = 'MANUTEN√á√ÉO';
                document.getElementById('login-error').textContent = 'Sistema em manuten√ß√£o. Tente novamente mais tarde.';
                return; // Para a execu√ß√£o aqui se estiver em manuten√ß√£o
            } else if (isLogout) { // Se for um logout, apenas mostra a tela de login e n√£o faz mais nada.
                return;
            }
            // --- L√ìGICA DE LOGIN E INICIALIZA√á√ÉO ---
            try {
                const tg = window.Telegram.WebApp;
                tg.ready();
                console.log("App pronto no Telegram.");
            } catch (e) {
                // Se o objeto do Telegram n√£o existir, cai aqui e usa o login manual
                console.log("App n√£o est√° no Telegram ou objeto n√£o encontrado.");
            }

            loadFromStorage();
            applySavedTheme();
            // Os listeners s√£o movidos para fora para sempre serem ativados

            document.getElementById('theme-switcher').addEventListener('click', toggleTheme);
            document.getElementById('logout-button').addEventListener('click', handleLogout);
            document.getElementById('forgot-password-link').addEventListener('click', handleForgotPassword);
            
            document.getElementById('reg_accessLevel').addEventListener('change', toggleTrialDurationField);
            setupPermissionControls();

            // NOVO: Listener para o toggle de hist√≥rico autom√°tico do Analisador Branco
            const autoImportBrancoHistoryToggle = document.getElementById('suite_autoImportBrancoHistory');
            const manualBrancoHistoryTextarea = document.getElementById('suite_inputHistoricoBranco');

            if (autoImportBrancoHistoryToggle && manualBrancoHistoryTextarea) {
                autoImportBrancoHistoryToggle.addEventListener('change', () => {
                    manualBrancoHistoryTextarea.disabled = autoImportBrancoHistoryToggle.checked;
                    manualBrancoHistoryTextarea.style.backgroundColor = autoImportBrancoHistoryToggle.checked ? '#333' : ''; // Escurece quando desabilitado
                    manualBrancoHistoryTextarea.value = ''; // Limpa o input manual quando o autom√°tico √© ativado
                });
            }
            // SUGEST√ÉO: Configura o link de suporte dinamicamente
            // Adiciona o listener para o novo controle do input de quantidade de sinais
            document.getElementById('suite_intervaloMinimoBranco').addEventListener('input', suite_toggleQtdSinaisBranco);
            suite_toggleQtdSinaisBranco(); // Chama uma vez para definir o estado inicial
            const supportLink = document.getElementById('support-link');
            if (supportLink) {
                supportLink.href = `tg://resolve?domain=${TELEGRAM_SUPPORT_USERNAME}`;
            }
            // Inicializa o app principal
            setupPasswordToggles(); // Configura todos os bot√µes de mostrar/ocultar senha
            toggleTrialDurationField(); // Garante que o campo de dura√ß√£o seja exibido ou ocultado corretamente no in√≠cio

            // NOVO: Inicializa a l√≥gica do Rob√¥ Autom√°tico
            const autoBotToggle = document.getElementById('autoBotToggle');
            if (autoBotToggle) autoBotToggle.addEventListener('change', handleAutoBotToggle);

            // NOVO: Inicializa a l√≥gica do Rob√¥ Branco
            const whiteBotToggle = document.getElementById('whiteBotToggle');
            if (whiteBotToggle) whiteBotToggle.addEventListener('change', handleWhiteBotToggle);

            // Listeners para o Rob√¥ Branco (Rota√ß√£o e Estrat√©gia)
            // Inicializa o painel de prote√ß√£o como desativado visualmente
            updateWhiteBotProtectionDisplay('disabled');

            const whiteBotRandomRotation = document.getElementById('whiteBotRandomRotation');
            const whiteBotStrategySelect = document.getElementById('whiteBotStrategy');
            if (whiteBotRandomRotation) {
                whiteBotRandomRotation.addEventListener('change', (e) => {
                    const label = document.getElementById('whiteBotCurrentStrategyLabel');
                    if (e.target.checked && label) {
                        label.innerHTML = '<div class="radar-animation" style="width: 8px; height: 8px; margin-right: 5px;"></div><span class="cortex-text-anim">ANALISANDO...</span>';
                    } else if (label) {
                        label.textContent = '';
                    }
                });
            }
            if (whiteBotStrategySelect) {
                whiteBotStrategySelect.addEventListener('change', () => {
                    const label = document.getElementById('whiteBotCurrentStrategyLabel');
                    if (whiteBotRandomRotation && whiteBotRandomRotation.checked && label) {
                        const strategyName = whiteBotStrategySelect.options[whiteBotStrategySelect.selectedIndex].text;
                        label.textContent = `[ ${strategyName} ]`;
                        updateWhiteBotStrategyStatsDisplay(); // Atualiza o destaque ao mudar manualmente
                    }
                });
            }

            // NOVO: Listener para mostrar estrat√©gia ao lado da rota√ß√£o
            const autoBotRandomRotation = document.getElementById('autoBotRandomRotation');
            const autoBotStrategySelect = document.getElementById('autoBotStrategy');
            
            if (autoBotRandomRotation) {
                autoBotRandomRotation.addEventListener('change', (e) => {
                    const label = document.getElementById('autoBotCurrentStrategyLabel');
                    if (e.target.checked) {
                        label.innerHTML = '<div class="radar-animation" style="width: 8px; height: 8px; margin-right: 5px;"></div><span class="cortex-text-anim">ANALISANDO...</span>';
                    } else {
                        label.textContent = '';
                    }
                });
            }
            
            if (autoBotStrategySelect) {
                autoBotStrategySelect.addEventListener('change', () => {
                    const label = document.getElementById('autoBotCurrentStrategyLabel');
                    if (autoBotRandomRotation && autoBotRandomRotation.checked && label) {
                        const strategyName = autoBotStrategySelect.options[autoBotStrategySelect.selectedIndex].text;
                        label.textContent = `[ ${strategyName} ]`;
                    }
                });
            }

            // Inicializa o display de estat√≠sticas do Rob√¥ Branco (mesmo vazio)
            updateWhiteBotStrategyStatsDisplay();
            
            // SUGEST√ÉO: Inicializa e atualiza o rel√≥gio
            updateClock(); // Chama uma vez para exibir imediatamente
            setInterval(updateClock, 1000); // Atualiza a cada segundo
            checkManualLogin();
            initializeApp();

            // L√≥gica para fazer o an√∫ncio de atualiza√ß√£o desaparecer
            const announcement = document.getElementById('update-announcement');
            if (announcement) {
                // SUGEST√ÉO: Adiciona estilo para o slider do novo toggle
                // REMOVIDO: A l√≥gica de cor do slider ser√° tratada via CSS para seguir o tema da plataforma.
                const autoFetchToggle = document.getElementById('dash_autoFetchToggle');
                setTimeout(() => {
                    announcement.style.opacity = '0';
                    announcement.style.marginBottom = '0'; // Remove a margem para um colapso suave
                    // Ap√≥s a transi√ß√£o, oculta completamente para n√£o interferir no layout
                    setTimeout(() => {
                        announcement.style.display = 'none';
                    }, 500); // Deve corresponder √† dura√ß√£o da transi√ß√£o do CSS
                }, 10000); // 10000 ms = 10 segundos
            }
        });

        // Configura o link do bot√£o de suporte do Telegram
        const supportButton = document.getElementById('telegram-support-button');
        if (supportButton) {
            const supportURL = `tg://resolve?domain=${TELEGRAM_SUPPORT_USERNAME}`;
            supportButton.href = supportURL;
        }

        // ==========================================
        // NOVA FUN√á√ÉO: SALVAR NO FIREBASE
        // ==========================================
        async function registerUser(event) {
            event.preventDefault();
            const form = document.getElementById('suite_userRegistrationForm');
            const outputArea = document.getElementById('suite_resCadastro');
            
            // Pega os dados do formul√°rio
            const username = document.getElementById('reg_username').value.trim();
            const password = document.getElementById('reg_password').value;
            const contact = document.getElementById('reg_contact').value.trim();
            const telegramId = document.getElementById('reg_telegram_id').value.trim() || null;
            const confirmPassword = document.getElementById('reg_confirmPassword').value;
            const accessLevel = document.getElementById('reg_accessLevel').value;
            const trialDays = document.getElementById('reg_trial_days').value;

            // --- Valida√ß√µes B√°sicas ---
            outputArea.style.display = 'block';
            outputArea.innerText = '‚è≥ Salvando no banco de dados...';
            outputArea.style.color = '#fff';

            if (!username || !password) {
                outputArea.innerText = '‚ùå ERRO: Nome de usu√°rio e senha s√£o obrigat√≥rios!';
                outputArea.style.color = 'var(--accent-blaze)';
                return;
            }
            if (password !== confirmPassword) {
                outputArea.innerText = '‚ùå ERRO: As senhas n√£o coincidem!';
                outputArea.style.color = 'var(--accent-blaze)';
                return;
            }

            // --- C√°lculo da Data de Expira√ß√£o ---
            let expirationDate = null;
            if (trialDays && !isNaN(parseInt(trialDays))) {
                const expDate = new Date();
                expDate.setDate(expDate.getDate() + parseInt(trialDays));
                expirationDate = expDate.toISOString();
            }

            // --- Cria o Objeto do Usu√°rio ---
            const newUser = {
                username: username,
                password: await hashPassword(password), // Hash seguro
                contact: contact || null,
                telegramId: telegramId,
                accessLevel: accessLevel,
                expiresAt: expirationDate,
                createdAt: new Date().toISOString() // Bom para saber quando foi criado
            };

            // --- SALVA NO FIREBASE (A M√°gica Acontece Aqui) ---
            // 1. Primeiro verificamos se o usu√°rio j√° existe
            db.collection("users").where("username", "==", username).get()
            .then((querySnapshot) => {
                if (!querySnapshot.empty) {
                    throw new Error("Este nome de usu√°rio j√° existe!");
                }
                // 2. Se n√£o existe, adiciona o novo
                return db.collection("users").add(newUser);
            })
            .then((docRef) => {
                // Sucesso!
                console.log("Usu√°rio salvo com ID: ", docRef.id);
                outputArea.innerText = `‚úÖ SUCESSO: Usu√°rio "${username}" salvo na nuvem!`;
                outputArea.style.color = 'var(--accent-jonbet)';
                form.reset();
                populateUserList(1); // Atualiza a lista de usu√°rios

                // Envia a mensagem de boas-vindas se o ID do Telegram foi fornecido
                if (telegramId) {
                    getTelegramSettings().then(settings => {
                        if (settings && settings.welcome_message) {
                            let welcomeMsg = settings.welcome_message;
                            const expirationDisplay = expirationDate 
                                ? new Date(expirationDate).toLocaleDateString('pt-BR')
                                : 'Permanente';

                            welcomeMsg = welcomeMsg.replace('{username}', username);
                            welcomeMsg = welcomeMsg.replace('{password}', password);
                            welcomeMsg = welcomeMsg.replace('{expiration_date}', expirationDisplay);

                            // Envia a mensagem para o ID do novo usu√°rio
                            sendTelegramNotification(welcomeMsg, telegramId);
                        }
                    });
                }
                
                // Atualiza a lista (vamos ajustar essa fun√ß√£o depois para ler do Firebase)
                // populateUserList(); 
            })
            .catch((error) => {
                console.error("Erro ao adicionar usu√°rio: ", error);
                outputArea.innerText = `‚ùå ERRO: ${error.message}`;
                outputArea.style.color = 'var(--accent-blaze)';
            });
        }

        async function editUser(userId) {
            try {
                // 1. Busca os dados mais recentes do usu√°rio no Firebase
                const userDoc = await db.collection("users").doc(userId).get();
                if (!userDoc.exists) {
                    alert('Erro: Usu√°rio n√£o encontrado no banco de dados.');
                    return;
                }
                const userToEdit = userDoc.data();

                // 2. Preenche o formul√°rio com os dados do usu√°rio
                document.getElementById('reg_username').value = userToEdit.username;
                document.getElementById('reg_contact').value = userToEdit.contact || '';
                document.getElementById('reg_telegram_id').value = userToEdit.telegramId || '';
                document.getElementById('reg_accessLevel').value = userToEdit.accessLevel;

                // 3. Limpa e ajusta os campos de senha
                document.getElementById('reg_password').value = '';
                document.getElementById('reg_confirmPassword').value = '';
                document.getElementById('reg_password').required = false; // Senha n√£o √© obrigat√≥ria na edi√ß√£o
                document.getElementById('reg_confirmPassword').required = false;
                document.getElementById('reg_password').placeholder = "Deixe em branco para n√£o alterar";

                // 4. Ajusta o formul√°rio para o modo de edi√ß√£o
                document.getElementById('reg_username').disabled = true; // Impede a altera√ß√£o do nome de usu√°rio
                document.getElementById('trial-duration-group').style.display = 'none'; // Oculta a dura√ß√£o do acesso
                document.getElementById('user-form-submit-btn').textContent = 'SALVAR ALTERA√á√ïES';
                document.getElementById('user-form-cancel-btn').style.display = 'block';

                // 5. Armazena o ID do documento para ser usado na hora de salvar
                const form = document.getElementById('suite_userRegistrationForm');
                form.dataset.editingUserId = userId; // Usando dataset para guardar o ID

                // 6. Rola a p√°gina para o topo para mostrar o formul√°rio
                window.scrollTo({ top: 0, behavior: 'smooth' });

            } catch (e) {
                console.error("Erro ao preparar edi√ß√£o do usu√°rio:", e);
                alert("Ocorreu uma falha ao carregar os dados do usu√°rio para edi√ß√£o.");
            }
        }

        function resetUserForm() {
            const form = document.getElementById('suite_userRegistrationForm');
            form.reset();
            delete form.dataset.editingUserId; // Limpa o ID de edi√ß√£o

            document.getElementById('reg_username').disabled = false;
            document.getElementById('reg_password').required = true;
            document.getElementById('reg_confirmPassword').required = true;
            document.getElementById('reg_password').placeholder = "";

            document.getElementById('user-form-submit-btn').textContent = 'CADASTRAR USU√ÅRIO';
            document.getElementById('user-form-cancel-btn').style.display = 'none';
            toggleTrialDurationField(); // Mostra/oculta o campo de dura√ß√£o conforme o n√≠vel de acesso
        }

        function registerUser_OLD(event) {
            event.preventDefault();
            const form = document.getElementById('suite_userRegistrationForm');
            const outputArea = document.getElementById('suite_resCadastro');            
            
            const username = document.getElementById('reg_username').value.trim();
            const password = document.getElementById('reg_password').value;
            const contact = document.getElementById('reg_contact').value.trim();
            const telegramId = document.getElementById('reg_telegram_id').value.trim();
            const confirmPassword = document.getElementById('reg_confirmPassword').value;
            const accessLevel = document.getElementById('reg_accessLevel').value;

            outputArea.style.display = 'block'; // Mostra a √°rea de output

            if (!username || !password) {
                outputArea.innerText = '‚ùå ERRO: Nome de usu√°rio e senha s√£o obrigat√≥rios!';
                outputArea.style.color = 'var(--accent-blaze)';
                return;
            }

            if (telegramId && !/^\d+$/.test(telegramId)) {
                outputArea.innerText = '‚ùå ERRO: O ID do Telegram deve conter apenas n√∫meros!';
                outputArea.style.color = 'var(--accent-blaze)';
                return;
            }

            if (password !== confirmPassword) {
                outputArea.innerText = '‚ùå ERRO: As senhas n√£o coincidem!';
                outputArea.style.color = 'var(--accent-blaze)';
                return;
            }
            
            // L√≥gica para cadastro pelo administrador (acesso imediato)
            try { // A l√≥gica de usu√°rios agora depender√° da sess√£o
                let users = JSON.parse(sessionStorage.getItem('app_users_temp')) || [];
                if (users.find(u => u.username.toLowerCase() === username.toLowerCase()) || username.toLowerCase() === 'operador') {
                    outputArea.innerText = `‚ùå ERRO: O nome de usu√°rio "${username}" j√° existe!`;
                    outputArea.style.color = 'var(--accent-blaze)';
                    return;
                }

                const trialDays = document.getElementById('reg_trial_days').value;
                let expirationDate = null;
                if (trialDays && !isNaN(parseInt(trialDays))) {
                    const expDate = new Date();
                    expDate.setDate(expDate.getDate() + parseInt(trialDays));
                    expirationDate = expDate.toISOString();
                }

                const newUser = {
                    username: username,
                    password: btoa(password), // Ofusca a senha usando Base64
                    contact: contact || null, // Salva o contato ou null se estiver vazio
                    telegramId: telegramId || null,
                    accessLevel: accessLevel,
                    expiresAt: expirationDate
                };

                users.push(newUser);
                sessionStorage.setItem('app_users_temp', JSON.stringify(users));

                outputArea.innerText = `‚úÖ SUCESSO: Usu√°rio "${username}" cadastrado.`;
                outputArea.style.color = 'var(--accent-jonbet)';
                form.reset();
                // Limpa a mensagem de sucesso ap√≥s alguns segundos
                setTimeout(() => {
                    outputArea.style.display = 'none';
                    outputArea.innerText = '';
                }, 5000);
                populateUserList(); // Atualiza a lista de usu√°rios
                sendAdminNotification('‚úÖ Novo Usu√°rio Criado', `O usu√°rio '${username}' foi cadastrado com sucesso.`);
            } catch (e) {
                console.error("Erro ao salvar usu√°rio:", e);
                outputArea.innerText = '‚ùå ERRO: Falha ao salvar o usu√°rio no armazenamento local.';
                outputArea.style.color = 'var(--accent-blaze)';
            }
        }

        let currentUserListPage = 1;
        let totalUserPages = 1;
        const usersPerPage = 10; // Alterado para 10 usu√°rios por p√°gina
        let userListSort = {
            column: 'username', // Coluna de ordena√ß√£o padr√£o
            direction: 'asc'    // Dire√ß√£o padr√£o
        };

        async function populateUserList(page = 1) {
            const tbody = document.getElementById('user-list-tbody');
            const paginationControls = document.getElementById('user-list-pagination');
            const pageIndicator = document.getElementById('user-page-indicator');
            const prevButton = document.getElementById('prev-user-page');
            const nextButton = document.getElementById('next-user-page');
        
            if (!tbody || !paginationControls) return;
            
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Carregando usu√°rios da nuvem...</td></tr>';
        
            try {
                const querySnapshot = await db.collection("users").get();
                let users = [];
                querySnapshot.forEach((doc) => {
                    // Adiciona o ID do documento do Firebase, que √© √∫til para editar/excluir
                    users.push({ id: doc.id, ...doc.data() });
                });
        
            // SUGEST√ÉO: Atualiza a contagem total de usu√°rios no cabe√ßalho.
            document.getElementById('user-count').textContent = users.length;

            const searchTerm = document.getElementById('user-search-input').value.toLowerCase();
            if (searchTerm) {
                users = users.filter(user => 
                    user.username.toLowerCase().includes(searchTerm)
                );
            }

            // L√≥gica de Ordena√ß√£o (existente)
            users.sort((a, b) => {
                let valA = a[userListSort.column];
                let valB = b[userListSort.column];

                // Tratamento especial para datas de expira√ß√£o
                if (userListSort.column === 'expiresAt') {
                    // Usu√°rios permanentes (null) s√£o considerados "maiores" que qualquer data
                    if (valA === null) return 1;
                    if (valB === null) return -1;
                    valA = new Date(valA).getTime();
                    valB = new Date(valB).getTime();
                } else {
                    // Ordena√ß√£o de texto padr√£o (case-insensitive)
                    valA = String(valA).toLowerCase();
                    valB = String(valB).toLowerCase();
                }

                if (valA < valB) return userListSort.direction === 'asc' ? -1 : 1;
                if (valA > valB) return userListSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            document.querySelectorAll('.sortable-header').forEach(th => th.classList.remove('asc', 'desc'));
            const activeHeader = document.getElementById(`sort-by-${userListSort.column}`);
            if (activeHeader) {
                activeHeader.classList.add(userListSort.direction);
            }

            currentUserListPage = page;

            const totalPages = Math.ceil(users.length / usersPerPage);
            totalUserPages = totalPages;
            if (totalPages <= 1) {
                paginationControls.style.display = 'none';
            } else {
                paginationControls.style.display = 'block';
            }

            pageIndicator.textContent = `P√°gina ${currentUserListPage} de ${totalPages}`;
            prevButton.disabled = (currentUserListPage === 1);
            nextButton.disabled = (currentUserListPage === totalPages);

            const startIndex = (currentUserListPage - 1) * usersPerPage;
            const endIndex = startIndex + usersPerPage;
            const paginatedUsers = users.slice(startIndex, endIndex);

            tbody.innerHTML = ''; // Limpa a lista
        
            paginatedUsers.forEach(user => {
                const isExpired = user.expiresAt && new Date(user.expiresAt) < new Date();
                const expirationText = user.expiresAt 
                    ? new Date(user.expiresAt).toLocaleString('pt-BR') 
                    : 'Permanente';

                const isBlocked = user.isBlocked === true;
                const blockButtonText = isBlocked ? 'Desbloquear' : 'Bloquear';
                const blockButtonStyle = isBlocked ? 'background: #28a745;' : 'background: #ffc107; color: #111;';
                let expirationDisplay = isBlocked ? 'BLOQUEADO' : (user.expiresAt ? new Date(user.expiresAt).toLocaleString('pt-BR') : 'Permanente');
                
                if (!isBlocked && isExpired) {
                    expirationDisplay += ' (EXPIRADO)';
                }

                const row = tbody.insertRow();
                const actionsCell = row.insertCell();
                actionsCell.style.whiteSpace = 'nowrap';

                row.innerHTML = `
                    <td>${user.username}</td>
                    <td>${user.contact || '-'}</td>
                    <td>${user.telegramId || 'N/A'}</td>
                    <td>${user.accessLevel}</td>
                    <td>${expirationDisplay}</td>
                `;

                if (isBlocked) {
                    row.classList.add('blocked-user');
                    row.title = 'Este usu√°rio est√° bloqueado manualmente.';
                } else if (isExpired) {
                    row.classList.add('expired-user');
                    row.title = 'O per√≠odo de acesso deste usu√°rio expirou.';
                }

                actionsCell.innerHTML = `
                    <button onclick="editUser('${user.id}')" class="user-action-btn edit" title="Editar usu√°rio"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg> Editar</button>
                    <button onclick="toggleUserBlock('${user.id}', ${isBlocked}, '${user.username}')" class="user-action-btn ${isBlocked ? 'unblock' : 'block'}" title="${blockButtonText}">${isBlocked ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zM9 8V6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9z"/></svg>' : '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6-9h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM7 8V6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H7z"/></svg>'}</button>
                    <button onclick="renewUser('${user.id}', '${user.username}')" class="user-action-btn renew" title="Adicionar dias de acesso"><svg xmlns="http://www.w.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg> + Dias</button>
                    <button onclick="deleteUser('${user.id}', '${user.username}')" class="user-action-btn delete" title="Excluir usu√°rio"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button>
                `;
                row.appendChild(actionsCell);
            });

            } catch (error) {
                console.error("Erro ao buscar usu√°rios do Firebase: ", error);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--accent-blaze);">Falha ao carregar usu√°rios.</td></tr>';
            }
        }

        function sortUserList(column) {
            if (userListSort.column === column) {
                // Se clicar na mesma coluna, inverte a dire√ß√£o
                userListSort.direction = userListSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                // Se clicar em uma nova coluna, define como ascendente
                userListSort.column = column;
                userListSort.direction = 'asc';
            }
            populateUserList(1); // Volta para a primeira p√°gina e reaplica a ordena√ß√£o
        }

        function nextUserPage() {
            if (currentUserListPage < totalUserPages) {
                populateUserList(currentUserListPage + 1);
            }
        }

        function prevUserPage() {
            if (currentUserListPage > 1) {
                populateUserList(currentUserListPage - 1);
            }
        }

        function copyUserIds(btnElement) {
            try {
                const users = JSON.parse(sessionStorage.getItem('app_users_temp')) || [];
                let idListText = 'Lista de Usu√°rios e IDs do Telegram:\n\n';

                users.forEach(user => {
                    if (user.telegramId) { // Inclui apenas usu√°rios que t√™m um ID
                        idListText += `Usu√°rio: ${user.username}, ID: ${user.telegramId}\n`;
                    }
                });

                navigator.clipboard.writeText(idListText).then(() => {
                    const originalText = btnElement.innerHTML;
                    btnElement.innerHTML = '‚úÖ Copiado!';
                    setTimeout(() => { btnElement.innerHTML = originalText; }, 2000);
                }).catch(err => console.error("Erro ao copiar IDs: ", err));

            } catch (e) {
                console.error("Erro ao gerar lista de IDs:", e);
                alert("Ocorreu uma falha ao tentar gerar a lista de IDs.");
            }
        }

        async function renewUser(userId, username) {
            const daysToAdd = prompt(`Quantos dias de acesso voc√™ deseja adicionar para o usu√°rio "${username}"?`, "7");

            if (daysToAdd === null || daysToAdd.trim() === '') {
                return; // Usu√°rio cancelou ou n√£o digitou nada
            }

            const days = parseInt(daysToAdd);
            if (isNaN(days) || days <= 0) {
                alert('Por favor, insira um n√∫mero de dias v√°lido e positivo.');
                return;
            }

            try {
                const userDoc = await db.collection("users").doc(userId).get();
                if (!userDoc.exists) {
                    alert('Erro: Usu√°rio n√£o encontrado no banco de dados.'); // CORRE√á√ÉO: Verificava vari√°vel errada
                    return;
                }
                const user = userDoc.data();

                // Se a conta j√° expirou ou √© permanente, a renova√ß√£o come√ßa a partir de hoje.
                // Se ainda n√£o expirou, adiciona dias √† data de expira√ß√£o existente.
                const startDate = (user.expiresAt && new Date(user.expiresAt) > new Date()) 
                    ? new Date(user.expiresAt) 
                    : new Date();
                
                startDate.setDate(startDate.getDate() + days);
                const newExpirationDate = startDate.toISOString();

                // Atualiza no Firebase
                await db.collection("users").doc(userId).update({ expiresAt: newExpirationDate });

                console.log(`Acesso do usu√°rio ${username} renovado at√© ${newExpirationDate}`);
                populateUserList(currentUserListPage); // Atualiza a lista para mostrar a nova data

            } catch (e) {
                console.error("Erro ao renovar o acesso do usu√°rio:", e);
                alert("Ocorreu uma falha ao tentar renovar o acesso.");
            }
        }

        async function toggleUserBlock(userId, isCurrentlyBlocked, username) {
            const action = isCurrentlyBlocked ? 'desbloquear' : 'bloquear';
            if (!confirm(`Tem certeza que deseja ${action} o usu√°rio "${username}"?`)) {
                return;
            }
        
            const newBlockedState = !isCurrentlyBlocked;
        
            try {
                // Atualiza o estado 'isBlocked' no Firebase
                await db.collection("users").doc(userId).update({ isBlocked: newBlockedState });
        
                console.log(`Usu√°rio ${username} foi ${action} com sucesso.`);
                
                // Envia notifica√ß√£o para o admin
                const adminMessage = `O usu√°rio *${username}* foi ${action.toUpperCase()} manualmente.`;
                sendTelegramNotification(adminMessage);

                populateUserList(currentUserListPage); // Atualiza a lista para refletir a mudan√ßa
            } catch (e) {
                console.error(`Erro ao ${action} o usu√°rio:`, e);
                alert(`Ocorreu uma falha ao tentar ${action} o usu√°rio.`);
            }
        }

        async function deleteUser(userId, username) {
            if (!confirm(`Tem certeza que deseja excluir o usu√°rio "${username}"? Esta a√ß√£o n√£o pode ser desfeita.`)) {
                return;
            }
        
            try {
                // Em vez de deletar, vamos atualizar o usu√°rio para "liberar" o ID do Telegram
                await db.collection("users").doc(userId).update({
                    telegramId: null, // Libera o ID do Telegram para novo cadastro
                    isBlocked: true, // Bloqueia o acesso da conta antiga
                    username: `${username}_excluido_${Date.now()}`, // Renomeia para liberar o username
                    notes: `Usu√°rio original '${username}' exclu√≠do em ${new Date().toLocaleString('pt-BR')}`
                });
        
                console.log(`Usu√°rio ${username} marcado como exclu√≠do e ID do Telegram liberado.`);
                populateUserList(1); // Atualiza a lista
        
                const outputArea = document.getElementById('suite_resCadastro');
                if (!outputArea) return;
                outputArea.innerText = `‚úÖ SUCESSO: Usu√°rio "${username}" foi exclu√≠do e seu ID do Telegram foi liberado para novo cadastro.`;
                outputArea.style.color = 'var(--accent-jonbet)';
                outputArea.style.display = 'block';
                setTimeout(() => { outputArea.style.display = 'none'; }, 5000);
        
                // Notifica o admin
                sendTelegramNotification(`üóëÔ∏è O usu√°rio *${username}* foi exclu√≠do. Seu ID do Telegram agora est√° livre para um novo cadastro.`);
        
            } catch (error) {
                console.error("Erro ao excluir usu√°rio:", error);
                alert("Falha ao processar a exclus√£o do usu√°rio.");
            }
        }

        async function clearDeletedUsers() {
            if (!confirm('Tem certeza que deseja remover permanentemente todos os usu√°rios marcados como "exclu√≠do"? Esta a√ß√£o n√£o pode ser desfeita.')) {
                return;
            }

            const outputArea = document.getElementById('suite_resCadastro');
            outputArea.style.display = 'block';
            outputArea.innerText = '‚è≥ Procurando e removendo usu√°rios exclu√≠dos...';
            outputArea.style.color = '#fff';

            try {
                // O Firestore n√£o suporta consultas 'contains' ou 'endsWith' de forma nativa.
                // A abordagem √© buscar todos os usu√°rios e filtrar no lado do cliente.
                // Para bases de dados muito grandes, uma Cloud Function seria mais eficiente.
                const querySnapshot = await db.collection("users").get();
                const batch = db.batch();
                let deletedCount = 0;

                querySnapshot.forEach(doc => {
                    const userData = doc.data();
                    if (userData.username && userData.username.includes('_excluido_')) {
                        batch.delete(doc.ref);
                        deletedCount++;
                    }
                });

                if (deletedCount > 0) {
                    await batch.commit();
                    outputArea.innerText = `‚úÖ SUCESSO: ${deletedCount} usu√°rio(s) exclu√≠do(s) foram removidos permanentemente.`;
                    outputArea.style.color = 'var(--accent-jonbet)';
                    populateUserList(1); // Atualiza a lista
                } else {
                    outputArea.innerText = '‚ÑπÔ∏è Nenhum usu√°rio marcado como "exclu√≠do" foi encontrado.';
                }
            } catch (error) {
                console.error("Erro ao limpar usu√°rios exclu√≠dos:", error);
                outputArea.innerText = '‚ùå Falha ao remover usu√°rios exclu√≠dos.';
                outputArea.style.color = 'var(--accent-blaze)';
            }
        }

        function toggleTrialDurationField() {
            const accessLevel = document.getElementById('reg_accessLevel').value;
            document.getElementById('trial-duration-group').style.display = (accessLevel === 'guest' || accessLevel === 'operator') ? 'block' : 'none';
        }

        function setupPermissionControls() {
            const permissionsGrid = document.getElementById('guest-permissions-grid');
            if (!permissionsGrid) return;

            const savedPermissions = JSON.parse(sessionStorage.getItem('guest_permissions_temp')) || { gerador: true }; // Padr√£o: Gerador I.A ativado

            permissionsGrid.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                const tabName = checkbox.dataset.tab;
                checkbox.checked = savedPermissions[tabName] || false;

                checkbox.addEventListener('change', () => {
                    const currentPermissions = JSON.parse(sessionStorage.getItem('guest_permissions_temp')) || {};
                    currentPermissions[tabName] = checkbox.checked;
                    sessionStorage.setItem('guest_permissions_temp', JSON.stringify(currentPermissions));
                });
            });
        }

        function getGuestPermissions() {
            const permissions = JSON.parse(sessionStorage.getItem('guest_permissions_temp'));
            // Se n√£o houver permiss√µes salvas, libera apenas o gerador por padr√£o.
            return permissions || { gerador: true };
        }

        async function logActivity(username, eventType, success) {
            try {
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    username: username,
                    event: eventType,
                    success: success
                };
        
                // Adiciona a nova entrada de log √† cole√ß√£o 'activity_log' no Firebase
                await db.collection("activity_log").add(logEntry);
                console.log("Atividade registrada no Firebase:", logEntry);
        
            } catch (e) {
                console.error("Erro ao registrar atividade:", e);
            }
        }

        async function populateActivityLog() {
            const tbody = document.getElementById('activity-log-tbody');
            if (!tbody) return;

            // SUGEST√ÉO: Pega o valor do novo campo de filtro
            const filterUsername = document.getElementById('activity-log-search-input').value.trim();

            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Carregando log de atividades...</td></tr>';
        
            try {
                let query = db.collection("activity_log").orderBy("timestamp", "desc");

                // SUGEST√ÉO: Adiciona o filtro de usu√°rio √† consulta se o campo estiver preenchido
                if (filterUsername) {
                    query = query.where("username", "==", filterUsername);
                }

                const querySnapshot = await query.limit(10).get();
        
                const activityLog = [];
                querySnapshot.forEach((doc) => {
                    activityLog.push(doc.data());
                });
        
                tbody.innerHTML = ''; // Limpa a tabela
        
                if (activityLog.length === 0) {
                    const message = filterUsername
                        ? `Nenhuma atividade encontrada para o usu√°rio "${filterUsername}".`
                        : "Nenhuma atividade registrada.";

                    tbody.innerHTML = `<tr><td colspan="4" style="text-align: center;">${message}</td></tr>`;
                    return;
                }
        
                activityLog.forEach(log => {
                    const row = tbody.insertRow();
                    const timestamp = new Date(log.timestamp).toLocaleString('pt-BR');
                    const status = log.success ? '‚úÖ Sucesso' : '‚ùå Falha';
                    row.innerHTML = `<td>${timestamp}</td><td>${log.username}</td><td>${log.event}</td><td>${status}</td>`;
                });
        
            } catch (error) {
                console.error("Erro ao buscar log de atividades:", error);
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--accent-blaze);">Falha ao carregar o log.</td></tr>';
            }
        }

        function clearActivityLog() {
            if (confirm('Tem certeza que deseja limpar todo o log de atividades?')) {
                sessionStorage.removeItem('app_activity_log_temp');
                populateActivityLog();
            }
        }

        function exportActivityLog() {
            try {
                const activityLog = JSON.parse(sessionStorage.getItem('app_activity_log_temp')) || [];

                if (activityLog.length === 0) {
                    alert("N√£o h√° atividades no log para exportar.");
                    return;
                }

                let logText = "Log de Atividades\n";
                logText += "========================================\n\n";

                activityLog.forEach(log => {
                    const timestamp = new Date(log.timestamp).toLocaleString('pt-BR');
                    const status = log.success ? 'Sucesso' : 'Falha';
                    logText += `Data/Hora: ${timestamp}\n`;
                    logText += `Usu√°rio:    ${log.username}\n`;
                    logText += `Evento:     ${log.event}\n`;
                    logText += `Status:     ${status}\n`;
                    logText += "----------------------------------------\n";
                });

                const blob = new Blob([logText], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `log_atividades_${new Date().toISOString().slice(0, 10)}.txt`;
                a.click();
                URL.revokeObjectURL(url);
            } catch (e) { console.error("Erro ao exportar log de atividades:", e); alert("Falha ao exportar o log."); }
        }

        function setupPasswordToggles() {
            document.querySelectorAll('.toggle-password').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const targetId = toggle.dataset.target;
                    const passwordInput = document.getElementById(targetId);
                    const iconEye = toggle.querySelector('.icon-eye');
                    const iconEyeOff = toggle.querySelector('.icon-eye-off');

                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        iconEye.style.display = 'none';
                        iconEyeOff.style.display = 'inline-block';
                    } else {
                        passwordInput.type = 'password';
                        iconEye.style.display = 'inline-block';
                        iconEyeOff.style.display = 'none';
                    }
                });
            });
        }

        function checkManualLogin() {
            // Verifica se o usu√°rio j√° est√° logado na sess√£o (login manual)
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                const operatorName = sessionStorage.getItem('operatorName');
                setupOperatorInfo(operatorName);
                showApp();
            }
            // Se n√£o, a tela de login continuar√° vis√≠vel por padr√£o.
        }

        function handleLogout() {
            // Limpa toda a sess√£o para garantir um logout completo
            sessionStorage.clear();
            localStorage.removeItem('isLoggedIn'); // Garante limpeza de persist√™ncia antiga se houver
            
            // Opcional: Recarregar a p√°gina sem par√¢metros de query para limpar estado da mem√≥ria JS
            if (window.location.search.includes('logout')) {
                 // J√° estamos na tela de logout
            }
            // Redireciona para a p√°gina com um par√¢metro de logout para for√ßar a tela de login,
            // mesmo em ambiente Telegram.
            window.location.href = window.location.pathname + '?logout=true';
        }

        function handleForgotPassword(event) {
            event.preventDefault();
            const username = prompt("Por favor, digite seu nome de usu√°rio para iniciar a recupera√ß√£o da senha:");

            if (!username || username.trim() === '') {
                alert("O nome de usu√°rio n√£o pode ser vazio.");
                return;
            }

            // Gera uma mensagem pr√©-preenchida para o usu√°rio enviar ao suporte via Telegram.
            const message = `Ol√°, esqueci minha senha para o usu√°rio '${username.trim()}'. Poderia me ajudar a recuper√°-la?`;
            const telegramUrl = `tg://resolve?domain=${TELEGRAM_SUPPORT_USERNAME}&text=${encodeURIComponent(message)}`;

            // Informa ao usu√°rio para entrar em contato com o suporte.
            document.getElementById('login-error').innerHTML = `Para redefinir sua senha, <a href="${telegramUrl}" target="_blank" style="color: var(--accent-jonbet); text-decoration: underline;">clique aqui para contatar o suporte via Telegram</a> e informe seu nome de usu√°rio.`;
        }

        function handleChangePassword(event) {
            event.preventDefault();
            const resultDiv = document.getElementById('change-password-result');
            const form = document.getElementById('change-password-form');

            const currentPassword = document.getElementById('current_password').value;
            const newPassword = document.getElementById('new_password').value;
            const confirmNewPassword = document.getElementById('confirm_new_password').value;

            resultDiv.style.display = 'block';

            if (!currentPassword || !newPassword || !confirmNewPassword) {
                resultDiv.textContent = '‚ùå ERRO: Todos os campos s√£o obrigat√≥rios.';
                resultDiv.style.color = 'var(--accent-blaze)';
                return;
            }

            if (newPassword !== confirmNewPassword) {
                resultDiv.textContent = '‚ùå ERRO: A nova senha e a confirma√ß√£o n√£o coincidem.';
                resultDiv.style.color = 'var(--accent-blaze)';
                return;
            }

            const username = sessionStorage.getItem('operatorName');
            const accessLevel = sessionStorage.getItem('accessLevel');

            // Caso especial para o administrador
            if (accessLevel === 'admin') {
                resultDiv.textContent = '‚ùå ERRO: A senha do administrador n√£o pode ser alterada por aqui.';
                resultDiv.style.color = 'var(--accent-blaze)';
                return;
            }

            try {
                let users = JSON.parse(sessionStorage.getItem('app_users_temp')) || [];
                const userIndex = users.findIndex(u => u.username.toLowerCase() === username.toLowerCase());

                if (userIndex === -1) {
                    resultDiv.textContent = '‚ùå ERRO: Usu√°rio n√£o encontrado no sistema.';
                    resultDiv.style.color = 'var(--accent-blaze)';
                    return;
                }

                const user = users[userIndex];
                if (user.password !== currentPassword) {
                    resultDiv.textContent = '‚ùå ERRO: A senha atual est√° incorreta.';
                    resultDiv.style.color = 'var(--accent-blaze)';
                    return;
                }

                // Atualiza a senha
                user.password = newPassword;
                sessionStorage.setItem('app_users_temp', JSON.stringify(users));

                resultDiv.textContent = '‚úÖ SUCESSO: Senha alterada!';
                resultDiv.style.color = 'var(--accent-jonbet)';
                form.reset();

            } catch (e) {
                console.error("Erro ao alterar senha:", e);
                resultDiv.textContent = '‚ùå ERRO: Ocorreu uma falha inesperada ao tentar alterar a senha.';
                resultDiv.style.color = 'var(--accent-blaze)';
            }
        }
    </script>
    <div class="navegacao">
        <a href="pagina1.html">Anterior</a> | <a href="pagina3.html">Pr√≥xima</a>
    </div>
</body>
</html>