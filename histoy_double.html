<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hist√≥rico Double</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(30, 41, 59, 0.7);
            border-radius: 15px;
            border: 1px solid rgba(100, 116, 139, 0.3);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            color: #f8fafc;
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #60a5fa, #818cf8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .subtitle {
            color: #94a3b8;
            font-size: 1.1rem;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(30, 41, 59, 0.7);
            border-radius: 15px;
            border: 1px solid rgba(100, 116, 139, 0.3);
        }

        .controls.minimized .filter-section-title,
        .controls.minimized .filter-row {
            display: none;
        }
        
        .date-input {
            flex: 1;
            min-width: 200px;
            padding: 12px 15px;
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 10px;
            color: #e2e8f0;
            font-size: 1rem;
        }
        
        .date-input:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
        }
        
        .btn {
            padding: 12px 25px;
            background: linear-gradient(90deg, #3b82f6, #6366f1);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
            background: linear-gradient(90deg, #2563eb, #4f46e5);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: rgba(30, 41, 59, 0.7);
            padding: 10px;
            border-radius: 10px;
            border: 1px solid rgba(100, 116, 139, 0.3);
            margin-bottom: 20px;
        }
        
        .stat-compact {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            line-height: 1;
            margin-bottom: 2px;
        }
        
        .red-stat { color: #f87171; }
        .black-stat { color: #cbd5e1; }
        .white-stat { color: #ffffff; }
        
        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 8px;
            margin-bottom: 30px;
        }
        
        .result-item {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.9rem;
            transition: transform 0.2s ease;
            position: relative;
            overflow: hidden;
            border: 2px solid transparent;
        }
        
        .result-item:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }
        
        .result-number {
            font-size: 1.1rem;
            margin-bottom: 0;
        }
        
        .result-time {
            font-size: 0.6rem;
            opacity: 0.8;
        }
        
        .result-red {
            background: linear-gradient(135deg, #dc2626, #991b1b);
            color: white;
            border-color: #f87171;
        }
        
        .result-black {
            background: linear-gradient(135deg, #1f2937, #111827);
            color: white;
            border-color: #4b5563;
        }
        
        .result-white {
            background: linear-gradient(135deg, #ffffff, #e2e8f0);
            color: #1f2937;
            border-color: #cbd5e1;
        }
        
        .load-more-container {
            text-align: center;
            margin-top: 30px;
            padding-bottom: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #94a3b8;
        }
        
        .error {
            text-align: center;
            padding: 40px;
            color: #f87171;
            background: rgba(220, 38, 38, 0.1);
            border-radius: 15px;
            border: 1px solid rgba(220, 38, 38, 0.3);
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: rgba(30, 41, 59, 0.7);
            border-radius: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
        
        /* Estilos compactos para o filtro */
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .filter-label {
            font-size: 0.85rem;
            color: #94a3b8;
            margin-left: 2px;
        }
        .compact-input {
            padding: 8px 12px;
            font-size: 0.9rem;
            min-width: auto;
        }
        .compact-btn {
            padding: 8px 15px;
            font-size: 0.9rem;
            min-width: auto;
        }
        .filter-section-title {
            width: 100%;
            font-size: 0.8rem;
            color: #64748b;
            margin-bottom: 8px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .date-separator {
            grid-column: 1 / -1;
            background: linear-gradient(90deg, #3b82f6, #6366f1);
            color: white;
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .rtl-grid {
            direction: rtl;
        }
        .rtl-grid .result-item {
            direction: ltr;
        }
        
        /* Ocultar Hor√°rios */
        .hide-times .result-time {
            display: none;
        }
        
        /* Destacar Brancos */
        .highlight-whites .result-item:not(.result-white) {
            opacity: 0.1;
            filter: grayscale(100%);
            transform: scale(0.85);
        }
        
        .highlight-whites .result-white {
            transform: scale(1.15);
            z-index: 5;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.6);
            border: 2px solid #fff;
        }
        
        /* Modo Coluna Ativa */
        .history-grid.masonry-mode {
            display: flex;
            gap: 4px;
            overflow-x: auto;
            align-items: flex-start;
        }
        
        .masonry-column {
            flex: 1;
            min-width: 60px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .masonry-header {
            background: rgba(51, 65, 85, 0.8);
            color: #94a3b8;
            font-weight: bold;
            text-align: center;
            border-radius: 4px;
            padding: 5px 0;
            font-size: 1rem;
        }
        
        .masonry-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .minute-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
        }
        
        .result-placeholder {
            background: rgba(30, 41, 59, 0.3);
            border: 2px dashed #475569;
            color: #64748b;
            cursor: default;
        }
        
        .result-placeholder:hover {
            transform: none;
            box-shadow: none;
        }
        
        /* Estilos da Aba Ferramentas e Toggle */
        .tools-bar {
            background: rgba(30, 41, 59, 0.7);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(100, 116, 139, 0.3);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 46px;
            height: 24px;
        }
        
        .switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #475569;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #3b82f6;
        }
        
        input:checked + .slider:before {
            transform: translateX(22px);
        }
        
        /* Estilos do Simulador */
        .simulation-container {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            padding: 0 5px;
            justify-content: center;
            align-items: flex-start;
        }
        
        .sim-item {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            background: rgba(30, 41, 59, 0.5);
            border: 2px dashed #64748b;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease;
        }
        
        .sim-item:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            border-color: #94a3b8;
        }
        
        .sim-item::after {
            content: "‚ùì";
            font-size: 1.2rem;
            opacity: 0.5;
        }
        
        .sim-item.sim-red { background: linear-gradient(135deg, #dc2626, #991b1b); border: 2px solid #f87171; }
        .sim-item.sim-black { background: linear-gradient(135deg, #1f2937, #111827); border: 2px solid #4b5563; }
        .sim-item.sim-white { background: linear-gradient(135deg, #ffffff, #e2e8f0); border: 2px solid #cbd5e1; }
        
        .sim-item.sim-red::after, .sim-item.sim-black::after, .sim-item.sim-white::after { content: ""; }

        @media (max-width: 768px) {
            .history-grid {
                grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            }
            
            h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header style="display: none;">
            <h1>Hist√≥rico Double</h1>
        </header>
        
        <div class="controls minimized">
            <div style="width: 100%; margin-bottom: 10px; font-size: 1.2rem; font-weight: bold; color: #e2e8f0; border-bottom: 1px solid rgba(148, 163, 184, 0.2); padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                <span>üõ†Ô∏è Filtros e Busca</span>
                <button id="toggleFiltersBtn" class="btn compact-btn" style="min-width: auto; background: #334155;" title="Minimizar/Expandir">‚ûï</button>
            </div>
            
            <!-- Linha 1: Datas e A√ß√µes Principais -->
            <div class="filter-section-title">Per√≠odo de Busca</div>
            <div class="filter-row">
                <div class="filter-group">
                    <span class="filter-label">In√≠cio</span>
                    <div style="display: flex; gap: 5px;">
                        <input type="date" id="startDate" class="date-input compact-input">
                        <input type="time" id="startTime" class="date-input compact-input">
                    </div>
                </div>
                
                <div class="filter-group">
                    <span class="filter-label">Fim</span>
                    <div style="display: flex; gap: 5px;">
                        <input type="date" id="endDate" class="date-input compact-input">
                        <input type="time" id="endTime" class="date-input compact-input">
                    </div>
                </div>

                <div class="filter-group" style="flex-direction: row; gap: 5px;">
                    <button id="fetchBtn" class="btn compact-btn" style="background: linear-gradient(90deg, #2563eb, #3b82f6);">üîç Buscar</button>
                    <button id="prevDayBtn" class="btn compact-btn" style="background: #475569;">üìÖ Ontem</button>
                </div>
            </div>
            
            <!-- Linha 2: Filtros Espec√≠ficos -->
            <div class="filter-section-title" style="margin-top: 15px;">Filtrar Resultados</div>
            <div class="filter-row">
                <div class="filter-group">
                    <span class="filter-label">Limite</span>
                    <input type="number" id="filterLimit" class="date-input compact-input" placeholder="Max 1500" max="1500" style="width: 80px;" value="300">
                </div>
                
                <div class="filter-group">
                    <span class="filter-label">Cor</span>
                    <select id="filterColor" class="date-input compact-input" style="width: 100px;">
                        <option value="">Todas</option>
                        <option value="red">Vermelho</option>
                        <option value="black">Preto</option>
                        <option value="white">Branco</option>
                    </select>
                </div>
                
                <div class="filter-group" style="flex-direction: row; gap: 5px;">
                    <div>
                        <span class="filter-label" style="display:block">N¬∫</span>
                        <input type="number" id="filterNumber" class="date-input compact-input" placeholder="0-14" min="0" max="14" style="width: 60px;">
                    </div>
                    <div>
                        <span class="filter-label" style="display:block">Hora</span>
                        <input type="number" id="filterHour" class="date-input compact-input" placeholder="0-23" min="0" max="23" style="width: 60px;">
                    </div>
                    <div>
                        <span class="filter-label" style="display:block">Min</span>
                        <input type="number" id="filterMinute" class="date-input compact-input" placeholder="0-59" min="0" max="59" style="width: 60px;">
                    </div>
                </div>
                
                <div class="filter-group" style="flex-direction: row; gap: 5px;">
                    <div>
                        <span class="filter-label">&nbsp;</span>
                        <button id="applyFiltersBtn" class="btn compact-btn" style="background: #0ea5e9;">‚ö° Aplicar</button>
                    </div>
                    <div>
                        <span class="filter-label">&nbsp;</span>
                        <button id="clearFiltersBtn" class="btn compact-btn" style="background: #ef4444;">üóëÔ∏è Limpar</button>
                    </div>
                </div>
                
                <div class="filter-group">
                    <span class="filter-label">&nbsp;</span>
                    <button id="lastMinuteBtn" class="btn compact-btn" style="background: linear-gradient(90deg, #10b981, #3b82f6);">‚è±Ô∏è √öltimo Minuto</button>
                </div>
            </div>
        </div>
        
        <div id="stats" class="stats">
            <!-- Estat√≠sticas ser√£o inseridas aqui dinamicamente -->
        </div>
        
        <div class="tools-bar">
            <div style="font-weight: bold; color: #94a3b8; margin-right: 10px;">üõ†Ô∏è Ferramentas</div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 0.9rem;">Inverter Ordem</span>
                <label class="switch">
                    <input type="checkbox" id="invertToggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 0.9rem;">Coluna Ativa</span>
                <label class="switch">
                    <input type="checkbox" id="activeColumnsToggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 0.9rem;">Ocultar Hor√°rios</span>
                <label class="switch">
                    <input type="checkbox" id="hideTimesToggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 0.9rem;">Destacar Brancos</span>
                <label class="switch">
                    <input type="checkbox" id="highlightWhitesToggle">
                    <span class="slider"></span>
                </label>
            </div>
            
            <div style="display: flex; align-items: center; gap: 10px; border-left: 1px solid rgba(148, 163, 184, 0.3); padding-left: 15px; margin-left: auto;">
                <span style="font-size: 0.9rem;">Simulador</span>
                <span id="simCounter" style="background: rgba(15, 23, 42, 0.5); padding: 2px 8px; border-radius: 4px; font-size: 0.9rem; min-width: 25px; text-align: center;">1</span>
                <button id="simMinusBtn" class="btn compact-btn" style="padding: 5px 10px; min-width: 30px; background: #ef4444;">-</button>
                <button id="simPlusBtn" class="btn compact-btn" style="padding: 5px 10px; min-width: 30px; background: #10b981;">+</button>
                <button id="simClearBtn" class="btn compact-btn" style="padding: 5px 10px; min-width: 30px; background: #f59e0b;" title="Limpar Tudo">üóëÔ∏è</button>
            </div>
        </div>

        <div id="simulationContainer" class="simulation-container"></div>

        <div id="results" class="history-grid">
            <!-- Resultados ser√£o inseridos aqui dinamicamente -->
        </div>
        
        <div class="load-more-container">
            <button id="loadMoreBtn" class="btn" style="display: none;">‚¨áÔ∏è Exibir Mais</button>
        </div>
    </div>

    <script>
        // Configura√ß√µes
        const API_BASE = 'https://blaze.bet.br/api/singleplayer-originals/originals/roulette_games/recent/history/1';
        let currentPage = 1;
        let currentStartDate = null;
        let currentEndDate = null;
        let allRecords = [];
        let lastRenderedDateString = null;

        // Elementos DOM
        const resultsContainer = document.getElementById('results');
        const statsContainer = document.getElementById('stats');
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        const prevDayBtn = document.getElementById('prevDayBtn');
        const fetchBtn = document.getElementById('fetchBtn');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const startTimeInput = document.getElementById('startTime');
        const endTimeInput = document.getElementById('endTime');
        const filterColor = document.getElementById('filterColor');
        const filterLimit = document.getElementById('filterLimit');
        const filterNumber = document.getElementById('filterNumber');
        const filterHour = document.getElementById('filterHour');
        const filterMinute = document.getElementById('filterMinute');
        const lastMinuteBtn = document.getElementById('lastMinuteBtn');
        const applyFiltersBtn = document.getElementById('applyFiltersBtn');
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        const invertToggle = document.getElementById('invertToggle');
        const activeColumnsToggle = document.getElementById('activeColumnsToggle');
        const hideTimesToggle = document.getElementById('hideTimesToggle');
        const highlightWhitesToggle = document.getElementById('highlightWhitesToggle');
        const toggleFiltersBtn = document.getElementById('toggleFiltersBtn');
        const controlsPanel = document.querySelector('.controls');
        const simPlusBtn = document.getElementById('simPlusBtn');
        const simMinusBtn = document.getElementById('simMinusBtn');
        const simClearBtn = document.getElementById('simClearBtn');
        const simulationContainer = document.getElementById('simulationContainer');
        const simCounter = document.getElementById('simCounter');

        // Inicializar datas (√∫ltimos 7 dias)
        function initializeDates() {
            const end = new Date();
            const start = new Date();
            start.setDate(start.getDate() - 365); // Define 1 ano atr√°s para permitir carregar mais hist√≥rico
            start.setHours(0, 0, 0, 0);
            end.setHours(23, 59, 59, 999);
            
            currentStartDate = start;
            currentEndDate = end;
            
            // Configurar bot√£o do dia anterior
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            prevDayBtn.textContent = `üìÖ ${yesterday.toLocaleDateString('pt-BR')}`;
        }

        // Formatar data para API
        function formatDateForAPI(date) {
            return date.toISOString().split('.')[0] + '.000Z';
        }

        // Delay auxiliar para evitar rate limit (Erro 429)
        const delay = ms => new Promise(resolve => setTimeout(resolve, ms));

        // Buscar dados da API
        async function fetchHistory(page = 1) {
            try {
                const isLoadMore = page > 1;
                
                if (!isLoadMore) {
                    showLoading();
                } else {
                    loadMoreBtn.textContent = 'Carregando...';
                    loadMoreBtn.disabled = true;
                }
                
                const startDate = currentStartDate || new Date(startDateInput.value);
                const endDate = currentEndDate || new Date(endDateInput.value);
                
                // Construir URL da API
                const targetUrl = `${API_BASE}?startDate=${formatDateForAPI(startDate)}&endDate=${formatDateForAPI(endDate)}&page=${page}`;
                // Adicionar timestamp para evitar cache
                const url = `https://corsproxy.io/?${encodeURIComponent(targetUrl)}&_t=${Date.now()}`;
                
                console.log('Buscando dados de:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data && data.records) {
                    currentPage = page; // Atualiza a p√°gina atual apenas em caso de sucesso
                    
                    if (!isLoadMore) {
                        allRecords = data.records;
                    } else {
                        allRecords = [...allRecords, ...data.records];
                        
                        // Atualiza o limite visual para n√£o ocultar os novos resultados carregados
                        const currentLimit = parseInt(filterLimit.value) || 0;
                        if (allRecords.length > currentLimit) {
                            filterLimit.value = allRecords.length;
                        }
                    }
                    
                    applyFilters();
                    
                    // Configurar bot√£o Exibir Mais
                    const totalPages = data.totalPages;
                    updateLoadMoreButton(page, totalPages, data.records.length);
                    
                    // Auto-carregamento se Limite > 100
                    const limitVal = parseInt(filterLimit.value);
                    if (limitVal > 100 && allRecords.length < limitVal) {
                        let hasMore = false;
                        if (totalPages) {
                            hasMore = page < totalPages;
                        } else {
                            hasMore = data.records.length >= 50;
                        }

                        if (hasMore) {
                            await fetchHistory(currentPage + 1);
                        }
                    }
                } else {
                    throw new Error('Formato de dados inv√°lido');
                }
                
            } catch (error) {
                console.error('Erro ao buscar hist√≥rico:', error);
                
                if (isLoadMore) {
                    loadMoreBtn.textContent = '‚ùå Erro - Tentar Novamente';
                    loadMoreBtn.disabled = false;
                } else {
                    showError(error.message);
                }
            }
        }

        // Aplicar filtros locais
        function applyFilters() {
            let filtered = [...allRecords];
            
            // Filtro de Cor
            const color = filterColor.value;
            if (color) {
                filtered = filtered.filter(r => {
                    const num = parseInt(r.roll != null ? r.roll : r.number);
                    let c = 'white';
                    if (num >= 1 && num <= 7) c = 'red';
                    else if (num >= 8 && num <= 14) c = 'black';
                    return c === color;
                });
            }
            
            // Filtro de N√∫mero
            const numVal = filterNumber.value;
            if (numVal !== '') {
                filtered = filtered.filter(r => {
                    const num = parseInt(r.roll != null ? r.roll : r.number);
                    return num === parseInt(numVal);
                });
            }
            
            // Filtro de Hora
            const hourVal = filterHour.value;
            if (hourVal !== '') {
                filtered = filtered.filter(r => {
                    const d = new Date(r.created_at);
                    return d.getHours() === parseInt(hourVal);
                });
            }

            // Filtro de Minuto
            const minVal = filterMinute.value;
            if (minVal !== '') {
                filtered = filtered.filter(r => {
                    const d = new Date(r.created_at);
                    return d.getMinutes() === parseInt(minVal);
                });
            }
            
            // Filtro de Quantidade
            const limitVal = filterLimit.value;
            if (limitVal !== '' && parseInt(limitVal) > 0) {
                filtered = filtered.slice(0, Math.min(parseInt(limitVal), 1500));
            }
            
            // Inverter Ordem se o toggle estiver ativado
            if (invertToggle.checked && !activeColumnsToggle.checked) {
                resultsContainer.classList.add('rtl-grid');
            } else {
                resultsContainer.classList.remove('rtl-grid');
            }
            
            if (activeColumnsToggle.checked) {
                resultsContainer.classList.add('masonry-mode');
            } else {
                resultsContainer.classList.remove('masonry-mode');
            }

            displayResults(filtered, false);
            updateStats(filtered);
        }

        // Exibir resultados
        function displayResults(records, append = false) {
            const useActiveColumns = activeColumnsToggle.checked;

            if (!append) {
                resultsContainer.innerHTML = '';
                lastRenderedDateString = null;
                
                if (useActiveColumns) {
                    for (let i = 0; i <= 9; i++) {
                        const col = document.createElement('div');
                        col.className = 'masonry-column';
                        col.dataset.colIndex = i;
                        
                        const header = document.createElement('div');
                        header.className = 'masonry-header';
                        header.textContent = i;
                        
                        const content = document.createElement('div');
                        content.className = 'masonry-content';
                        
                        col.appendChild(header);
                        col.appendChild(content);
                        resultsContainer.appendChild(col);
                    }
                    
                    // Adicionar placeholders para completar a linha 0-9 com hor√°rios futuros
                    if (allRecords.length > 0) {
                        const latest = allRecords[0];
                        const latestTime = new Date(latest.created_at);
                        const latestDigit = latestTime.getMinutes() % 10;
                        
                        // Preenche os minutos restantes at√© 9
                        for (let i = latestDigit + 1; i <= 9; i++) {
                            const colContent = resultsContainer.querySelector(`.masonry-column[data-col-index="${i}"] .masonry-content`);
                            if (colContent) {
                                const group = document.createElement('div');
                                group.className = 'minute-group';
                                colContent.appendChild(group);
                                
                                const diffMinutes = i - latestDigit;
                                const futureTime = new Date(latestTime.getTime() + diffMinutes * 60000);
                                const timeString = futureTime.toLocaleTimeString('pt-BR', { 
                                    hour: '2-digit', 
                                    minute: '2-digit' 
                                });

                                // Adicionar 2 placeholders para representar as duas pedras do minuto
                                for (let j = 0; j < 2; j++) {
                                    const placeholder = document.createElement('div');
                                    placeholder.className = 'result-item result-placeholder';
                                    placeholder.innerHTML = `
                                        <div style="font-size: 1.2rem;">‚è≥</div>
                                        <div class="result-time">${timeString}</div>
                                    `;
                                    placeholder.title = "Aguardando resultado...";
                                    group.appendChild(placeholder);
                                }
                            }
                        }
                    }
                }
            }
            
            if (!records || records.length === 0) {
                if (!append) resultsContainer.innerHTML = '<div class="error">Nenhum resultado encontrado para o per√≠odo selecionado</div>';
                return;
            }
            
            records.forEach(record => {
                const time = new Date(record.created_at);
                const dateString = time.toLocaleDateString('pt-BR');

                if (!useActiveColumns && lastRenderedDateString && lastRenderedDateString !== dateString) {
                    const separator = document.createElement('div');
                    separator.className = 'date-separator';
                    separator.textContent = `üìÖ ${dateString}`;
                    resultsContainer.appendChild(separator);
                }
                lastRenderedDateString = dateString;

                const resultItem = document.createElement('div');
                resultItem.className = 'result-item';
                
                const number = parseInt(record.roll != null ? record.roll : record.number);
                
                // Determinar cor baseada no n√∫mero
                let colorClass = 'result-white';
                if (number >= 1 && number <= 7) {
                    colorClass = 'result-red';
                } else if (number >= 8 && number <= 14) {
                    colorClass = 'result-black';
                }
                
                resultItem.className += ' ' + colorClass;
                
                // Formatar hor√°rio
                const timeString = time.toLocaleTimeString('pt-BR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                // Adicionar n√∫mero e hor√°rio
                const numberDiv = document.createElement('div');
                numberDiv.className = 'result-number';
                const displayValue = record.roll != null ? record.roll : (record.number != null ? record.number : '?');
                numberDiv.textContent = displayValue;
                
                const timeDiv = document.createElement('div');
                timeDiv.className = 'result-time';
                timeDiv.textContent = timeString;
                
                resultItem.appendChild(numberDiv);
                resultItem.appendChild(timeDiv);
                
                // Tooltip com informa√ß√µes detalhadas
                resultItem.title = `N√∫mero: ${displayValue}\nCor: ${record.color}\nData: ${time.toLocaleString('pt-BR')}`;
                
                // L√≥gica da Coluna Ativa
                if (useActiveColumns) {
                    const minuteLastDigit = time.getMinutes() % 10;
                    const colContent = resultsContainer.querySelector(`.masonry-column[data-col-index="${minuteLastDigit}"] .masonry-content`);
                    if (colContent) {
                        const minuteKey = timeString;
                        
                        // Procura por um grupo existente para este minuto
                        let group = colContent.querySelector(`div[data-minute="${minuteKey}"]`);

                        // Se o grupo n√£o existe, cria um novo e o insere na posi√ß√£o correta
                        if (!group) {
                            group = document.createElement('div');
                            group.className = 'minute-group';
                            group.dataset.minute = minuteKey;

                            let inserted = false;
                            // Itera sobre os grupos existentes para encontrar a posi√ß√£o correta (mantendo a ordem decrescente)
                            for (const existingGroup of colContent.children) {
                                if (minuteKey > existingGroup.dataset.minute) {
                                    colContent.insertBefore(group, existingGroup);
                                    inserted = true;
                                    break;
                                }
                            }
                            if (!inserted) {
                                colContent.appendChild(group); // Adiciona no final se for o mais antigo
                            }
                        }
                        
                        group.prepend(resultItem);
                    }
                } else {
                    resultsContainer.appendChild(resultItem);
                }
            });
        }

        // Atualizar estat√≠sticas
        function updateStats(records) {
            if (!records || records.length === 0) return;
            
            const stats = {
                red: 0,
                black: 0,
                white: 0,
                total: records.length,
                lastUpdate: new Date().toLocaleTimeString('pt-BR')
            };
            
            records.forEach(record => {
                const number = parseInt(record.roll != null ? record.roll : record.number);
                if (number >= 1 && number <= 7) stats.red++;
                else if (number >= 8 && number <= 14) stats.black++;
                else stats.white++;
            });
            
            // Calcular percentuais
            const redPercent = ((stats.red / stats.total) * 100).toFixed(1);
            const blackPercent = ((stats.black / stats.total) * 100).toFixed(1);
            const whitePercent = ((stats.white / stats.total) * 100).toFixed(1);
            
            statsContainer.innerHTML = `
                <div class="stat-compact">
                    <div class="stat-value red-stat">${stats.red}</div>
                    <div style="font-size: 0.75rem; color: #94a3b8;">Vermelho</div>
                    <div style="font-size: 0.7rem; color: #64748b;">${redPercent}%</div>
                </div>
                <div style="width: 1px; height: 30px; background: rgba(255,255,255,0.1);"></div>
                <div class="stat-compact">
                    <div class="stat-value black-stat">${stats.black}</div>
                    <div style="font-size: 0.75rem; color: #94a3b8;">Preto</div>
                    <div style="font-size: 0.7rem; color: #64748b;">${blackPercent}%</div>
                </div>
                <div style="width: 1px; height: 30px; background: rgba(255,255,255,0.1);"></div>
                <div class="stat-compact">
                    <div class="stat-value white-stat">${stats.white}</div>
                    <div style="font-size: 0.75rem; color: #94a3b8;">Branco</div>
                    <div style="font-size: 0.7rem; color: #64748b;">${whitePercent}%</div>
                </div>
                <div style="width: 1px; height: 30px; background: rgba(255,255,255,0.1);"></div>
                <div class="stat-compact">
                    <div class="stat-value" style="color: #60a5fa;">${stats.total}</div>
                    <div style="font-size: 0.75rem; color: #94a3b8;">Total</div>
                    <div style="font-size: 0.7rem; color: #64748b;">${stats.lastUpdate}</div>
                </div>
            `;
        }

        // Atualizar estado do bot√£o Exibir Mais
        function updateLoadMoreButton(current, totalPages, currentCount) {
            let hasMore = false;
            if (totalPages) {
                hasMore = current < totalPages;
            } else {
                // Fallback: se recebeu 50 itens (limite padr√£o), assume que tem mais
                hasMore = currentCount >= 50;
            }

            if (hasMore) {
                loadMoreBtn.style.display = 'inline-block';
                loadMoreBtn.textContent = '‚¨áÔ∏è Exibir Mais';
                loadMoreBtn.disabled = false;
            } else {
                loadMoreBtn.style.display = 'none';
            }
        }

        // Mostrar estado de carregamento
        function showLoading() {
            resultsContainer.innerHTML = '<div class="loading">Carregando resultados...</div>';
            statsContainer.innerHTML = '';
            loadMoreBtn.style.display = 'none';
        }

        // Mostrar erro
        function showError(message) {
            resultsContainer.innerHTML = `
                <div class="error">
                    <h3>‚ö†Ô∏è Erro ao carregar dados</h3>
                    <p>${message}</p>
                    <p>Verifique sua conex√£o e tente novamente.</p>
                </div>
            `;
        }

        // Event Listeners
        fetchBtn.addEventListener('click', () => {
            const startD = startDateInput.value;
            const startT = startTimeInput.value;
            const endD = endDateInput.value;
            const endT = endTimeInput.value;
            
            if (!startD || !endD) {
                alert('Por favor, selecione as datas de in√≠cio e fim.');
                return;
            }
            
            currentStartDate = new Date(`${startD}T${startT || '00:00'}`);
            currentEndDate = new Date(`${endD}T${endT || '23:59'}`);
            currentPage = 1;
            fetchHistory(currentPage);
        });

        loadMoreBtn.addEventListener('click', () => {
            fetchHistory(currentPage + 1);
        });

        prevDayBtn.addEventListener('click', () => {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            yesterday.setHours(0, 0, 0, 0);
            
            const endYesterday = new Date(yesterday);
            endYesterday.setHours(23, 59, 59, 999);
            
            // Ajustar inputs (visual)
            const yyyy = yesterday.getFullYear();
            const mm = String(yesterday.getMonth() + 1).padStart(2, '0');
            const dd = String(yesterday.getDate()).padStart(2, '0');
            const dateStr = `${yyyy}-${mm}-${dd}`;
            
            startDateInput.value = dateStr;
            endDateInput.value = dateStr;
            startTimeInput.value = '00:00';
            endTimeInput.value = '23:59';
            
            currentStartDate = yesterday;
            currentEndDate = endYesterday;
            currentPage = 1;
            fetchHistory(1);
        });

        // Bot√£o √öltimo Minuto
        lastMinuteBtn.addEventListener('click', () => {
            const now = new Date();
            const oneMinAgo = new Date(now.getTime() - 60000); // 1 minuto atr√°s
            
            // Ajustar inputs para visualiza√ß√£o
            startDateInput.valueAsDate = oneMinAgo;
            endDateInput.valueAsDate = now;
            
            startTimeInput.value = oneMinAgo.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
            endTimeInput.value = now.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
            
            // Disparar busca
            fetchBtn.click();
        });

        // Bot√£o Aplicar Filtros
        applyFiltersBtn.addEventListener('click', () => {
            const limitVal = parseInt(filterLimit.value);
            
            // Se o limite for maior que os registros atuais, busca mais dados
            if (limitVal && limitVal > allRecords.length) {
                if (allRecords.length === 0) {
                    fetchHistory(1);
                } else {
                    fetchHistory(currentPage + 1);
                }
            } else {
                applyFilters();
            }
        });

        // Bot√£o Limpar Filtros
        clearFiltersBtn.addEventListener('click', () => {
            filterColor.value = '';
            filterNumber.value = '';
            filterHour.value = '';
            filterMinute.value = '';
            filterLimit.value = '';
            applyFilters();
        });

        // Evento do bot√£o Inverter
        invertToggle.addEventListener('change', () => {
            applyFilters();
        });

        // Evento do bot√£o Coluna Ativa
        activeColumnsToggle.addEventListener('change', () => {
            applyFilters();
        });
        
        // Evento do bot√£o Ocultar Hor√°rios
        hideTimesToggle.addEventListener('change', () => {
            if (hideTimesToggle.checked) {
                resultsContainer.classList.add('hide-times');
            } else {
                resultsContainer.classList.remove('hide-times');
            }
        });
        
        // Evento do bot√£o Destacar Brancos
        highlightWhitesToggle.addEventListener('change', () => {
            if (highlightWhitesToggle.checked) {
                resultsContainer.classList.add('highlight-whites');
            } else {
                resultsContainer.classList.remove('highlight-whites');
            }
        });

        // Evento Minimizar Filtros
        toggleFiltersBtn.addEventListener('click', () => {
            controlsPanel.classList.toggle('minimized');
            toggleFiltersBtn.textContent = controlsPanel.classList.contains('minimized') ? '‚ûï' : '‚ûñ';
        });

        // Fun√ß√£o para criar o layout do simulador
        function createSimulatorLayout() {
            simulationContainer.innerHTML = '';
            
            for (let i = 0; i <= 9; i++) {
                const col = document.createElement('div');
                col.className = 'masonry-column';
                
                const header = document.createElement('div');
                header.className = 'masonry-header';
                header.textContent = i;
                col.appendChild(header);
                
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.gap = '4px';
                row.style.justifyContent = 'center';

                for (let j = 0; j < 2; j++) {
                    const btn = document.createElement('div');
                    btn.className = 'sim-item';
                    btn.title = 'Clique para alterar a cor';
                    
                    btn.addEventListener('click', () => {
                        if (btn.classList.contains('sim-red')) {
                            btn.classList.remove('sim-red');
                            btn.classList.add('sim-black');
                        } else if (btn.classList.contains('sim-black')) {
                            btn.classList.remove('sim-black');
                            btn.classList.add('sim-white');
                        } else if (btn.classList.contains('sim-white')) {
                            btn.classList.remove('sim-white');
                        } else {
                            btn.classList.add('sim-red');
                        }
                    });
                    row.appendChild(btn);
                }
                col.appendChild(row);
                simulationContainer.appendChild(col);
            }
            if (simCounter) simCounter.textContent = '1';
        }

        // Event Listeners do Simulador
        simPlusBtn.addEventListener('click', () => {
            const columns = simulationContainer.querySelectorAll('.masonry-column');
            
            if (columns.length === 0) {
                createSimulatorLayout();
            } else {
                columns.forEach(col => {
                    const row = document.createElement('div');
                    row.style.display = 'flex';
                    row.style.gap = '4px';
                    row.style.justifyContent = 'center';
                    row.style.marginTop = '4px';

                    for (let j = 0; j < 2; j++) {
                        const btn = document.createElement('div');
                        btn.className = 'sim-item';
                        btn.title = 'Clique para alterar a cor';
                        
                        btn.addEventListener('click', () => {
                            if (btn.classList.contains('sim-red')) {
                                btn.classList.remove('sim-red');
                                btn.classList.add('sim-black');
                            } else if (btn.classList.contains('sim-black')) {
                                btn.classList.remove('sim-black');
                                btn.classList.add('sim-white');
                            } else if (btn.classList.contains('sim-white')) {
                                btn.classList.remove('sim-white');
                            } else {
                                btn.classList.add('sim-red');
                            }
                        });
                        row.appendChild(btn);
                    }
                    col.appendChild(row);
                });
                if (simCounter) simCounter.textContent = parseInt(simCounter.textContent || 0) + 1;
            }
        });

        simMinusBtn.addEventListener('click', () => {
            const columns = simulationContainer.querySelectorAll('.masonry-column');
            if (columns.length > 0) {
                columns.forEach(col => {
                    // Remove o √∫ltimo elemento se n√£o for o cabe√ßalho
                    if (col.lastElementChild && !col.lastElementChild.classList.contains('masonry-header')) {
                        col.removeChild(col.lastElementChild);
                    }
                });
                if (simCounter) {
                    const current = parseInt(simCounter.textContent || 0);
                    simCounter.textContent = Math.max(0, current - 1);
                }
            } else {
                simulationContainer.innerHTML = '';
                if (simCounter) simCounter.textContent = '0';
            }
        });

        simClearBtn.addEventListener('click', () => {
            simulationContainer.innerHTML = '';
            if (simCounter) simCounter.textContent = '0';
        });

        // Auto-refresh inteligente a cada 10 segundos
        setInterval(() => {
            updateLatestResults();
        }, 10000);

        async function updateLatestResults() {
            // Verifica se a data final selecionada √© hoje (ou futuro)
            const todayStr = new Date().toISOString().split('T')[0];
            const selectedEndStr = endDateInput.value;
            
            // Se tiver data selecionada e for anterior a hoje, n√£o atualiza
            if (selectedEndStr && selectedEndStr < todayStr) return;

            try {
                // Busca sempre a p√°gina 1 para novos resultados
                const startDate = currentStartDate || new Date();
                const endDate = new Date(); // Hora atual
                
                const targetUrl = `${API_BASE}?startDate=${formatDateForAPI(startDate)}&endDate=${formatDateForAPI(endDate)}&page=1`;
                const url = `https://corsproxy.io/?${encodeURIComponent(targetUrl)}&_t=${Date.now()}`;
                
                const response = await fetch(url, { method: 'GET', headers: { 'Accept': 'application/json' } });
                if (!response.ok) return;
                
                const data = await response.json();
                if (data && data.records && data.records.length > 0) {
                    const newRecords = data.records;
                    // Filtra apenas os que n√£o est√£o na lista atual (por ID)
                    const existingIds = new Set(allRecords.map(r => r.id));
                    const trulyNewRecords = newRecords.filter(r => !existingIds.has(r.id));
                    
                    if (trulyNewRecords.length > 0) {
                        allRecords = [...trulyNewRecords, ...allRecords];
                        applyFilters();
                    }
                }
            } catch (error) {
                console.error('Erro no auto-refresh:', error);
            }
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            initializeDates();
            fetchHistory();
            createSimulatorLayout(); // Inicia o simulador automaticamente
        });

        // Fun√ß√£o para salvar dados localmente (opcional)
        function saveToLocalStorage(records) {
            try {
                const history = JSON.parse(localStorage.getItem('blazeHistory') || '[]');
                const newRecords = records.filter(record => 
                    !history.some(h => h.id === record.id)
                );
                
                if (newRecords.length > 0) {
                    history.unshift(...newRecords);
                    localStorage.setItem('blazeHistory', JSON.stringify(history.slice(0, 1000)));
                }
            } catch (error) {
                console.error('Erro ao salvar no localStorage:', error);
            }
        }
    </script>
</body>
</html>